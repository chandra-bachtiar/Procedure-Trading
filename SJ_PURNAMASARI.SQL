CREATE PROCEDURE SJ_PURNAMASARI(
  NO_SJ VARCHAR(20))
RETURNS(
  KODE_BARANG VARCHAR(20),
  GUDANG VARCHAR(20),
  NAMA_BARANG VARCHAR(200),
  QTY DECIMAL(18, 2),
  KODE_SATUAN VARCHAR(6),
  TANGGAL DATE,
  OPERATOR VARCHAR(50),
  FAKTUR VARCHAR(100),
  LIST_FAKTUR VARCHAR(500),
  LIST_CUSTOMER VARCHAR(500))
AS
DECLARE VARIABLE TMP_GUDANG VARCHAR(20);
DECLARE VARIABLE TMP_FAKTUR VARCHAR(500);
DECLARE VARIABLE TMP_CUSTOMER VARCHAR(500);
BEGIN
    TMP_GUDANG = '';
	FOR
      SELECT 
      E.KODE_BARANG,
      C.GUDANG,
      E.NAMA_BARANG,
      SUM(C.QTY)QTY,
      C.KODE_SATUAN,
      A.TANGGAL,
      F.NAMA
      FROM MT_SURAT_JALAN A 
      INNER JOIN DT_SURAT_JALAN B ON B.NO_SJ = A.NO_SJ
      INNER JOIN DT_PENJUALAN C ON C.NO_FAKTUR = B.NO_FAKTUR
      INNER JOIN MST_BARANG_JUAL D ON D.KODE_JUAL = C.KODE_BARANG
                                 AND D.KODE_SATUAN = C.KODE_SATUAN
      INNER JOIN MST_BARANG E ON E.KODE_BARANG = D.KODE_BARANG
      LEFT JOIN MST_OPERATOR F ON F.KODE_OPERATOR = A.USER_INPUT
      WHERE A.NO_SJ = :NO_SJ
      GROUP BY E.KODE_BARANG,C.GUDANG,E.NAMA_BARANG,C.KODE_SATUAN,A.TANGGAL,F.NAMA
      ORDER BY C.GUDANG
      INTO :KODE_BARANG,:GUDANG,:NAMA_BARANG,:QTY,:KODE_SATUAN,:TANGGAL,:OPERATOR
    DO
    BEGIN
       IF(COALESCE(TMP_GUDANG,'') <> COALESCE(GUDANG,'')) THEN
       BEGIN
       		LIST_FAKTUR = '';LIST_CUSTOMER = '';
    	    SELECT 
            LIST(XX.NO_FAKTUR,',')
            FROM(
              SELECT
              DISTINCT
              Y.NO_FAKTUR
              FROM
              DT_SURAT_JALAN Y
              INNER JOIN DT_PENJUALAN Z ON Z.NO_FAKTUR = Y.NO_FAKTUR
              WHERE Y.NO_SJ = :NO_SJ AND Z.GUDANG = :GUDANG
            )XX
            INTO :LIST_FAKTUR;
            
            SELECT
            LIST(QQ.NAMA_CUSTOMER,',')
            FROM(
              SELECT
              DISTINCT
              R.NAMA_CUSTOMER
              FROM
              DT_SURAT_JALAN P
              INNER JOIN DT_PENJUALAN O ON O.NO_FAKTUR = P.NO_FAKTUR
              INNER JOIN MT_PENJUALAN Q ON Q.NO_FAKTUR = O.NO_FAKTUR
              INNER JOIN MST_CUSTOMER R ON R.KODE_CUSTOMER = Q.KODE_CUSTOMER
              WHERE P.NO_SJ = :NO_SJ AND O.GUDANG = :GUDANG
            )QQ
            INTO :LIST_CUSTOMER;
        	TMP_CUSTOMER = LIST_CUSTOMER;
            TMP_FAKTUR = LIST_FAKTUR;
       END
       ELSE
       BEGIN
       		LIST_FAKTUR = TMP_FAKTUR;
            LIST_CUSTOMER = TMP_CUSTOMER;
       END
       TMP_GUDANG = GUDANG;
    SUSPEND;
    END
END;
